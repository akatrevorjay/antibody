#!/usr/bin/env zsh
set -eo pipefail

SELF="$(basename "$0")"
SELF_ABS_PATH="$(dirname "$(realpath "$0")")"

-antibody-wrapper() {
    # First priority is the local copy in this repo.
    # If it's not build, then perform standard PATH resolution.
    PATH="$SELF_ABS_PATH:$PATH" antibody "$@"
}

ANTIBODY="$(which antibody 2>/dev/null)"
while 
ANTIBODY_PATH="$SELF_ABS_PATH"

ABS_SELF="$(which "antibody" || realpath "$0")"
ANTIBODY
if [[ -z "$ANTIBODY" ]]; then
    ANTIBODY=realpath "$0")"

[[ -n "$ANTIBODY" ]] || (echo "Cannot find antibody binary" >&2; exit 1)

antibody() {
  case "$1" in
      bundle|update)
        while read bundle; do
          source "$bundle"
        done < <( $antibody "$@" )
        ;;
  *)
    $ANTIBODY $@
    ;;
  esac
}

_antibody() {
  IFS=' ' read -A reply <<< "$(echo "bundle update list help")"
}
compctl -K _antibody antibody
